<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flappy Bird – Advanced Interview-Grade Implementation</title>
  <style>
    body {
      margin: 0;
      background: radial-gradient(circle at top, #70c5ce, #1f6f82);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: system-ui, sans-serif;
    }
    .wrapper { position: relative; }
    canvas {
      background: linear-gradient(#70c5ce, #d0f4f7);
      border-radius: 16px;
      box-shadow: 0 35px 70px rgba(0,0,0,0.5);
    }
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      color: #fff;
      text-align: center;
    }
    .panel {
      background: rgba(0,0,0,0.6);
      padding: 22px 28px;
      border-radius: 14px;
    }
    .panel h1 { margin: 0 0 6px; font-size: 24px; }
    .panel p { margin: 4px 0; font-size: 14px; opacity: 0.9; }
  </style>
</head>
<body>
<div class="wrapper">
  <canvas id="game" width="360" height="512"></canvas>
  <div class="overlay" id="overlay"></div>
</div>

<script>
// ======================================================
// ENGINE CORE
// ======================================================
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');

let lastTime = 0;
let paused = false;

// ======================================================
// CONFIG
// ======================================================
const CONFIG = {
  gravity: 2400,            // px/s²
  flapVelocity: -520,       // px/s
  pipeWidth: 56,
  baseGap: 150,
  speed: 180,               // px/s
  spawnInterval: 1.6,       // seconds
  maxTilt: Math.PI / 5
};

// ======================================================
// STATE MACHINE
// ======================================================
const STATE = { READY: 0, PLAYING: 1, GAMEOVER: 2 };
let state = STATE.READY;

let score = 0;
let best = Number(localStorage.getItem('bestScore') || 0);

// ======================================================
// ENTITY SYSTEM
// ======================================================
class Bird {
  constructor() {
    this.reset();
  }
  reset() {
    this.x = 90;
    this.y = canvas.height / 2;
    this.r = 12;
    this.vy = 0;
    this.rotation = 0;
  }
  flap() {
    this.vy = CONFIG.flapVelocity;
  }
  update(dt) {
    this.vy += CONFIG.gravity * dt;
    this.y += this.vy * dt;
    this.rotation = Math.min(CONFIG.maxTilt, this.vy / 600);
  }
  draw() {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);
    ctx.fillStyle = '#ffd000';
    ctx.beginPath();
    ctx.arc(0, 0, this.r, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}

class Pipe {
  constructor() { this.active = false; }
  spawn(score) {
    const variance = Math.random() * 140 - 70;
    const gap = CONFIG.baseGap - Math.min(score * 2, 50);
    const center = canvas.height / 2 + variance;
    this.top = center - gap / 2;
    this.bottom = center + gap / 2;
    this.x = canvas.width;
    this.passed = false;
    this.active = true;
  }
  update(dt) {
    this.x -= (CONFIG.speed + score * 6) * dt;
    if (this.x + CONFIG.pipeWidth < 0) this.active = false;
  }
  draw() {
    ctx.fillStyle = '#2ecc71';
    ctx.fillRect(this.x, 0, CONFIG.pipeWidth, this.top);
    ctx.fillRect(this.x, this.bottom, CONFIG.pipeWidth, canvas.height - this.bottom);
  }
}

// ======================================================
// OBJECT POOL
// ======================================================
const pipePool = Array.from({ length: 6 }, () => new Pipe());
let spawnTimer = 0;

function getPipe() {
  return pipePool.find(p => !p.active);
}

// ======================================================
// INPUT
// ======================================================
function handleInput() {
  if (state === STATE.READY) startGame();
  else if (state === STATE.PLAYING) bird.flap();
  else if (state === STATE.GAMEOVER) resetGame();
}

window.addEventListener('keydown', e => {
  if (e.code === 'Space') handleInput();
  if (e.code === 'KeyP') paused = !paused;
});
canvas.addEventListener('mousedown', handleInput);

// ======================================================
// GAME FLOW
// ======================================================
const bird = new Bird();

function startGame() {
  state = STATE.PLAYING;
  overlay.innerHTML = '';
}

function gameOver() {
  state = STATE.GAMEOVER;
  best = Math.max(best, score);
  localStorage.setItem('bestScore', best);
  overlay.innerHTML = `
    <div class="panel">
      <h1>Game Over</h1>
      <p>Score: <strong>${score}</strong></p>
      <p>Best: <strong>${best}</strong></p>
      <p>Space / Click to restart</p>
      <p>Press P to pause</p>
    </div>`;
}

function resetGame() {
  bird.reset();
  pipePool.forEach(p => p.active = false);
  spawnTimer = 0;
  score = 0;
  state = STATE.READY;
  overlay.innerHTML = `
    <div class="panel">
      <h1>Flappy Bird</h1>
      <p>Space or Click to start</p>
      <p>P = Pause</p>
    </div>`;
}

// ======================================================
// COLLISION
// ======================================================
function collides(pipe) {
  if (!pipe.active) return false;
  const bx = bird.x;
  const by = bird.y;
  const r = bird.r;

  if (bx + r > pipe.x && bx - r < pipe.x + CONFIG.pipeWidth) {
    if (by - r < pipe.top || by + r > pipe.bottom) return true;
  }
  return false;
}

// ======================================================
// UPDATE & RENDER
// ======================================================
function update(dt) {
  if (state !== STATE.PLAYING || paused) return;

  bird.update(dt);

  spawnTimer += dt;
  if (spawnTimer > CONFIG.spawnInterval) {
    const pipe = getPipe();
    if (pipe) pipe.spawn(score);
    spawnTimer = 0;
  }

  pipePool.forEach(p => {
    if (!p.active) return;
    p.update(dt);

    if (!p.passed && p.x + CONFIG.pipeWidth < bird.x) {
      p.passed = true;
      score++;
    }

    if (collides(p)) gameOver();
  });

  if (bird.y + bird.r > canvas.height || bird.y - bird.r < 0) gameOver();
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  pipePool.forEach(p => p.active && p.draw());
  bird.draw();

  ctx.fillStyle = '#fff';
  ctx.font = '32px system-ui';
  ctx.fillText(score, canvas.width / 2 - 8, 42);

  if (paused && state === STATE.PLAYING) {
    ctx.fillStyle = 'rgba(0,0,0,0.4)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#fff';
    ctx.font = '20px system-ui';
    ctx.fillText('Paused', 140, 260);
  }
}

// ======================================================
// MAIN LOOP (DELTA TIME)
// ======================================================
function loop(time) {
  const dt = Math.min((time - lastTime) / 1000, 0.033);
  lastTime = time;

  update(dt);
  draw();
  requestAnimationFrame(loop);
}

// INIT
resetGame();
requestAnimationFrame(loop);
</script>
</body>
</html>
