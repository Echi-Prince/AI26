<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Educational 808 Drum Machine</title>
<style>
  body {
    margin: 0;
    padding: 20px;
    background: #0d001a;
    color: #e0d0ff;
    font-family: Arial, Helvetica, sans-serif;
    min-height: 100vh;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
  }

  h1 {
    text-align: center;
    color: #ff4d4d;
    margin: 0 0 30px;
    font-size: 2.4rem;
    letter-spacing: 3px;
  }

  .top-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
  }

  button {
    padding: 12px 24px;
    font-size: 1.1rem;
    border: none;
    border-radius: 8px;
    background: #3a2a5a;
    color: white;
    cursor: pointer;
    transition: all 0.15s;
  }

  button:hover { background: #5a4a7a; }
  button.active { background: #ff4d4d; box-shadow: 0 0 15px #ff4d4daa; }

  .bpm-group {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  input[type="range"] {
    width: 160px;
    accent-color: #ff4d4d;
  }

  .sequencer {
    display: grid;
    grid-template-columns: 140px repeat(16, 1fr);
    gap: 6px 8px;
    background: #110033;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 12px 40px #000c;
  }

  .track-label {
    text-align: right;
    font-weight: bold;
    color: #aa88ff;
    padding-right: 16px;
    font-size: 1.15rem;
    align-self: center;
  }

  .step {
    height: 0;
    padding-bottom: 100%; /* square */
    background: #1a0044;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid #2a0066;
    transition: all 0.12s;
  }

  .step.on {
    background: #ff4d4d;
    box-shadow: 0 0 14px #ff4d4d88;
    border-color: #ff7777;
  }

  .step.playhead {
    background: #ffdd88 !important;
    box-shadow: 0 0 20px #ffdd88cc;
    transform: scale(1.12);
  }

  .info {
    margin-top: 30px;
    text-align: center;
    color: #bb99ff;
    font-size: 0.95rem;
    line-height: 1.6;
  }
</style>
</head>
<body>

<div class="container">
  <h1>808 Style Drum Machine</h1>

  <div class="top-controls">
    <div>
      <button id="play">Play</button>
      <button id="stop">Stop</button>
      <button id="clear">Clear</button>
    </div>

    <div class="bpm-group">
      <label>BPM: <span id="bpmDisplay">120</span></label>
      <input type="range" id="bpm" min="70" max="180" value="120" step="1">
    </div>
  </div>

  <div class="sequencer" id="grid"></div>

  <div class="info">
    Click squares to place hits • 16-step pattern • Web Audio API synthesis<br>
    Inspired by the classic Roland TR-808 drum machine
  </div>
</div>

<script>
// ────────────────────────────────────────────────────────────────
const ctx = new (window.AudioContext || window.webkitAudioContext)();

let isPlaying = false;
let currentStep = 0;
let bpm = 120;
let timer = null;

// Sound triggers (each returns a function that plays the sound when called)
const instruments = {
  kick:    createKick(),
  snare:   createSnare(),
  clap:    createClap(),
  chh:     createClosedHat(),
  ohh:     createOpenHat(),
  lowtom:  createLowTom(),
  rim:     createRim(),
  cowbell: createCowbell()
};

const trackNames = [
  "Kick", "Snare", "Clap", "Closed HH", "Open HH", "Low Tom", "Rim Shot", "Cowbell"
];

// ─── Build UI ────────────────────────────────────────────────────
const gridEl = document.getElementById("grid");
const steps = [];

trackNames.forEach((name, rowIdx) => {
  // Label
  const label = document.createElement("div");
  label.className = "track-label";
  label.textContent = name;
  gridEl.appendChild(label);

  // 16 steps per row
  steps[rowIdx] = [];
  for (let col = 0; col < 16; col++) {
    const step = document.createElement("div");
    step.className = "step";
    step.dataset.row = rowIdx;
    step.dataset.col = col;
    step.addEventListener("click", () => step.classList.toggle("on"));
    gridEl.appendChild(step);
    steps[rowIdx][col] = step;
  }
});

// ─── Transport ───────────────────────────────────────────────────
function schedule() {
  const stepDurationMs = (60 / bpm) * 1000 / 4; // 16th notes

  document.querySelectorAll(".step.playhead").forEach(el => el.classList.remove("playhead"));

  for (let row = 0; row < steps.length; row++) {
    const stepEl = steps[row][currentStep];
    stepEl.classList.add("playhead");

    if (stepEl.classList.contains("on")) {
      const instrumentName = Object.keys(instruments)[row];
      instruments[instrumentName](); // trigger sound
    }
  }

  currentStep = (currentStep + 1) % 16;
}

function start() {
  if (isPlaying) return;
  ctx.resume().then(() => {
    isPlaying = true;
    document.getElementById("play").textContent = "Playing";
    document.getElementById("play").classList.add("active");
    currentStep = 0;
    schedule(); // immediate first step
    timer = setInterval(schedule, (60 / bpm) * 1000 / 4);
  });
}

function stop() {
  isPlaying = false;
  clearInterval(timer);
  document.querySelectorAll(".step.playhead").forEach(el => el.classList.remove("playhead"));
  document.getElementById("play").textContent = "Play";
  document.getElementById("play").classList.remove("active");
}

// ─── Controls ────────────────────────────────────────────────────
document.getElementById("play").onclick = start;
document.getElementById("stop").onclick = stop;
document.getElementById("clear").onclick = () => {
  document.querySelectorAll(".step.on").forEach(el => el.classList.remove("on"));
};

document.getElementById("bpm").oninput = e => {
  bpm = +e.target.value;
  document.getElementById("bpmDisplay").textContent = bpm;
  if (isPlaying) {
    clearInterval(timer);
    timer = setInterval(schedule, (60 / bpm) * 1000 / 4);
  }
};

// ─── Sound Engines ───────────────────────────────────────────────

function createKick() {
  return () => {
    const now = ctx.currentTime;
    const osc = ctx.createOscillator();
    osc.type = "sine";
    osc.frequency.setValueAtTime(180, now);
    osc.frequency.exponentialRampToValueAtTime(50, now + 0.10);

    const gain = ctx.createGain();
    gain.gain.setValueAtTime(1.2, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.40);

    osc.connect(gain).connect(ctx.destination);
    osc.start(now);
    osc.stop(now + 0.45);
  };
}

function createSnare() {
  return () => {
    const now = ctx.currentTime;
    const noise = createNoise(0.22);
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.95, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.18);
    noise.connect(gain).connect(ctx.destination);
    noise.start(now);
    noise.stop(now + 0.22);
  };
}

function createClap() {
  return () => {
    const now = ctx.currentTime;
    [0, 8].forEach(delayMs => {
      setTimeout(() => {
        const n = createNoise(0.14);
        const g = ctx.createGain();
        g.gain.setValueAtTime(0.75, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.13);
        n.connect(g).connect(ctx.destination);
        n.start();
        n.stop(ctx.currentTime + 0.15);
      }, delayMs);
    });
  };
}

function createClosedHat() {
  return () => {
    const now = ctx.currentTime;
    const noise = createNoise(0.05);
    const filt = ctx.createBiquadFilter();
    filt.type = "highpass";
    filt.frequency.value = 8000;
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.65, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.035);
    noise.connect(filt).connect(gain).connect(ctx.destination);
    noise.start(now);
    noise.stop(now + 0.06);
  };
}

function createOpenHat() {
  return () => {
    const now = ctx.currentTime;
    const noise = createNoise(0.45);
    const filt = ctx.createBiquadFilter();
    filt.type = "highpass";
    filt.frequency.value = 5500;
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.55, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.38);
    noise.connect(filt).connect(gain).connect(ctx.destination);
    noise.start(now);
    noise.stop(now + 0.45);
  };
}

function createLowTom() {
  return () => {
    const now = ctx.currentTime;
    const osc = ctx.createOscillator();
    osc.type = "sine";
    osc.frequency.setValueAtTime(140, now);
    osc.frequency.exponentialRampToValueAtTime(55, now + 0.20);
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.95, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.42);
    osc.connect(gain).connect(ctx.destination);
    osc.start(now);
    osc.stop(now + 0.48);
  };
}

function createRim() {
  return () => {
    const now = ctx.currentTime;

    // Noise burst
    const n = createNoise(0.07);
    const gn = ctx.createGain();
    gn.gain.setValueAtTime(0.55, now);
    gn.gain.exponentialRampToValueAtTime(0.001, now + 0.06);
    n.connect(gn).connect(ctx.destination);
    n.start(now);
    n.stop(now + 0.08);

    // Click tone
    const osc = ctx.createOscillator();
    osc.type = "triangle";
    osc.frequency.value = 220;
    const go = ctx.createGain();
    go.gain.setValueAtTime(0.45, now);
    go.gain.exponentialRampToValueAtTime(0.001, now + 0.09);
    osc.connect(go).connect(ctx.destination);
    osc.start(now);
    osc.stop(now + 0.11);
  };
}

function createCowbell() {
  return () => {
    const now = ctx.currentTime;
    const osc1 = ctx.createOscillator(); osc1.frequency.value = 540;
    const osc2 = ctx.createOscillator(); osc2.frequency.value = 800;
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.6, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.14);
    osc1.connect(gain);
    osc2.connect(gain);
    gain.connect(ctx.destination);
    osc1.start(now); osc2.start(now);
    osc1.stop(now + 0.16); osc2.stop(now + 0.16);
  };
}

function createNoise(seconds) {
  const len = ctx.sampleRate * seconds;
  const buffer = ctx.createBuffer(1, len, ctx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < len; i++) data[i] = Math.random() * 2 - 1;
  const src = ctx.createBufferSource();
  src.buffer = buffer;
  return src;
}

</script>
</body>
</html>
